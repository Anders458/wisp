#!/usr/bin/env php
<?php

require_once __DIR__ . '/../vendor/autoload.php';

use Symfony\Component\Console\Application;
use Wisp\Console\Command\CacheClearCommand;
use Wisp\Console\Command\DebugContainerCommand;
use Wisp\Console\Command\RouteListCommand;
use Wisp\Console\Command\TestCommand;
use Wisp\Console\Command\TokenGenerateCommand;
use Wisp\Environment\Stage;
use Wisp\Wisp;

// Detect if running from a project or framework directory
$projectRoot = getcwd();
$projectConsoleBootstrap = $projectRoot . '/console.php';

// Check for project console.php first (preferred method)
if (file_exists($projectConsoleBootstrap)) {
   // Running from a project with custom console configuration
   $console = require $projectConsoleBootstrap;
   $console->run();
   exit(0);
}

// Fallback: Check for project bootstrap file
$projectBootstrap = $projectRoot . '/public/index.php';

if (file_exists($projectBootstrap)) {
   // Running from a project - load the project app
   $app = require $projectBootstrap;

   if (!$app instanceof Wisp) {
      throw new RuntimeException('public/index.php must return a Wisp instance');
   }

   $root = defined('ROOT') ? ROOT : $projectRoot;
   $console = new Application('Wisp Console', '1.0.0');

   // Add RouteListCommand with actual project routes
   $console->add(new RouteListCommand($app->router));
   $console->add(new TestCommand($app));
} else {
   // Running from framework directory - create minimal app
   $root = dirname(__DIR__);

   $app = new Wisp([
      'root' => $root,
      'debug' => true,
      'stage' => Stage::development
   ]);

   $console = new Application('Wisp Framework', '1.0.0');
}

// Add common commands available in both modes
$console->add(new CacheClearCommand($root));
$console->add(new DebugContainerCommand());
$console->add(new TokenGenerateCommand());

$console->run();
